#!/system/bin/sh
#
# USB RNDIS tether setup
# shade@chemlab.org (cyanogen)
#

IN=usb0
OUT=rmnet0
OUT2=tiwlan0
ADDR=192.168.77.254
MASK=255.255.255.0
TOGGLE=/sys/devices/virtual/net/${IN}/enable
FORWARD=/proc/sys/net/ipv4/ip_forward

case "$1" in
	start)
		ifconfig $IN up $ADDR netmask $MASK	
		echo 1 > $TOGGLE
		echo 1 > $FORWARD
                
                # create (or at least empty) chain for forwarded packets
                iptables -N usbtether
                iptables -F usbtether
                # we let packets pass belonging to connections that are already established
		iptables -A usbtether -m state --state RELATED,ESTABLISHED -j ACCEPT
                # other packets originating from the inner device are also allowed to pass
                iptables -A usbtether -i $IN -j ACCEPT

                # hook the usbtether rules into the FORWARDING chain
                # send all packets that are send or received by the USB network
                # through the filter chain
                iptables -A FORWARD -i $IN -j usbtether
                iptables -A FORWARD -o $IN -j usbtether

		iptables -t nat -A POSTROUTING -o $OUT  -j MASQUERADE
		iptables -t nat -A POSTROUTING -o $OUT2 -j MASQUERADE

		start dnsmasq
        setprop tethering.enabled 1
		;;

	stop)
		stop dnsmasq
		ifconfig $IN down
		echo 0 > $TOGGLE
		echo 0 > $FORWARD
                
                # disable masquerading
                iptables -t nat -D POSTROUTING -o $OUT  -j MASQUERADE
                iptables -t nat -D POSTROUTING -o $OUT2 -j MASQUERADE

                # remove references to the usbtether chain
                iptables -D FORWARD -i $IN -j usbtether
                iptables -D FORWARD -o $IN -j usbtether

                # destroy the usbtether chain
                iptables -F usbtether
                iptables -X usbtether

        setprop tethering.enabled 0
		;;
	*)
		echo "Usage: $0 {start|stop}"
		exit 1
esac

exit 0

